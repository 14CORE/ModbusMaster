<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ModbusMaster: ModbusMaster Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>ModbusMaster Class Reference</h1><!-- doxytag: class="ModbusMaster" -->
<p>Arduino class library for communicating with Modbus slaves over RS232/485 (via RTU protocol).  
<a href="#_details">More...</a></p>

<p><code>#include &lt;<a class="el" href="_modbus_master_8h_source.html">ModbusMaster.h</a>&gt;</code></p>

<p><a href="class_modbus_master-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__setup.html#gac33a5bbc8188eb4a3a9a6bf8494bdc27">ModbusMaster</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Constructor.  <a href="group__setup.html#gac33a5bbc8188eb4a3a9a6bf8494bdc27"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__setup.html#ga79102d6dd559b647c8a5a385184b89cd">ModbusMaster</a> (uint8_t)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__setup.html#ga508ecee40cf75898f27f8404c1574164">ModbusMaster</a> (uint8_t, uint8_t)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__setup.html#ga0f393213ede2f78801fca5add4eab139">begin</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize class object.  <a href="group__setup.html#ga0f393213ede2f78801fca5add4eab139"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__setup.html#gabc1145dc790c2b8da2d5c20ff34b187e">begin</a> (uint16_t)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__buffer.html#ga2584dd744a983ec2f898cdc42ab303cc">GetResponseBuffer</a> (uint8_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Retrieve data from response buffer.  <a href="group__buffer.html#ga2584dd744a983ec2f898cdc42ab303cc"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__buffer.html#ga451b1b008c828f73e549adf4963ec4f3">ClearResponseBuffer</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Clear Modbus response buffer.  <a href="group__buffer.html#ga451b1b008c828f73e549adf4963ec4f3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__buffer.html#ga19a72b096a5d55e873c72ffbc266ea76">SetTransmitBuffer</a> (uint8_t, uint16_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Place data in transmit buffer.  <a href="group__buffer.html#ga19a72b096a5d55e873c72ffbc266ea76"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__buffer.html#ga6329ee7505ea915c76402cb6779566bd">ClearTransmitBuffer</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Clear Modbus transmit buffer.  <a href="group__buffer.html#ga6329ee7505ea915c76402cb6779566bd"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__discrete.html#ga869b01cb329ac2198d0ca1f73f0b7e73">ReadCoils</a> (uint16_t, uint16_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x01 Read Coils.  <a href="group__discrete.html#ga869b01cb329ac2198d0ca1f73f0b7e73"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__discrete.html#gacb43f90117b8fdd7d3ff54080c3843e7">ReadDiscreteInputs</a> (uint16_t, uint16_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x02 Read Discrete Inputs.  <a href="group__discrete.html#gacb43f90117b8fdd7d3ff54080c3843e7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__register.html#gad2c69a07c3b4d51b6c0bfaed9f66e706">ReadHoldingRegisters</a> (uint16_t, uint16_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x03 Read Holding Registers.  <a href="group__register.html#gad2c69a07c3b4d51b6c0bfaed9f66e706"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__register.html#ga5a5e0cb50243ef16b2984defdcf01ed8">ReadInputRegisters</a> (uint16_t, uint8_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x04 Read Input Registers.  <a href="group__register.html#ga5a5e0cb50243ef16b2984defdcf01ed8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__discrete.html#gacabeba64621bcaf296c5aed215397948">WriteSingleCoil</a> (uint16_t, uint8_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x05 Write Single Coil.  <a href="group__discrete.html#gacabeba64621bcaf296c5aed215397948"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__register.html#gad33a10be38b84bfb59b18d9a1cd5060f">WriteSingleRegister</a> (uint16_t, uint16_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x06 Write Single Register.  <a href="group__register.html#gad33a10be38b84bfb59b18d9a1cd5060f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__discrete.html#ga4c53ff0f62db2bfa87858afd821ae4a8">WriteMultipleCoils</a> (uint16_t, uint16_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x0F Write Multiple Coils.  <a href="group__discrete.html#ga4c53ff0f62db2bfa87858afd821ae4a8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__register.html#gacbd4d0469c4e48697819ab0e1f87c43e">WriteMultipleRegisters</a> (uint16_t, uint16_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x10 Write Multiple Registers.  <a href="group__register.html#gacbd4d0469c4e48697819ab0e1f87c43e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__register.html#ga56ecb5f566796f40232eeebd976074be">MaskWriteRegister</a> (uint16_t, uint16_t, uint16_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x16 Mask Write Register.  <a href="group__register.html#ga56ecb5f566796f40232eeebd976074be"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__register.html#ga33427f6572c175dfc83213fa51dd6544">ReadWriteMultipleRegisters</a> (uint16_t, uint16_t, uint16_t, uint16_t)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x17 Read Write Multiple Registers.  <a href="group__register.html#ga33427f6572c175dfc83213fa51dd6544"></a><br/></td></tr>
<tr><td colspan="2"><h2>Static Public Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__constant.html#gaf69c1c360b84adc5bf1c7bbe071f1970">ku8MBIllegalFunction</a> = 0x01</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus protocol illegal function exception.  <a href="group__constant.html#gaf69c1c360b84adc5bf1c7bbe071f1970"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__constant.html#ga5d90968b8bbc157f9937c2d9a866102d">ku8MBIllegalDataAddress</a> = 0x02</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus protocol illegal data address exception.  <a href="group__constant.html#ga5d90968b8bbc157f9937c2d9a866102d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__constant.html#gaa49d578ceaa82518573b3f7e2d925322">ku8MBIllegalDataValue</a> = 0x03</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus protocol illegal data value exception.  <a href="group__constant.html#gaa49d578ceaa82518573b3f7e2d925322"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__constant.html#ga3b26f812363d765a334d72635da74fe5">ku8MBSlaveDeviceFailure</a> = 0x04</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus protocol slave device failure exception.  <a href="group__constant.html#ga3b26f812363d765a334d72635da74fe5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__constant.html#ga81dd9e8d2936e369359777d67769a657">ku8MBSuccess</a> = 0x00</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><a class="el" href="class_modbus_master.html" title="Arduino class library for communicating with Modbus slaves over RS232/485 (via RTU...">ModbusMaster</a> success.  <a href="group__constant.html#ga81dd9e8d2936e369359777d67769a657"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__constant.html#ga19521b4671bdc1ded03af72e2f3b958e">ku8MBInvalidSlaveID</a> = 0xE0</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><a class="el" href="class_modbus_master.html" title="Arduino class library for communicating with Modbus slaves over RS232/485 (via RTU...">ModbusMaster</a> invalid response slave ID exception.  <a href="group__constant.html#ga19521b4671bdc1ded03af72e2f3b958e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__constant.html#ga31e9072531cf487c137b68b5e1e68926">ku8MBInvalidFunction</a> = 0xE1</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><a class="el" href="class_modbus_master.html" title="Arduino class library for communicating with Modbus slaves over RS232/485 (via RTU...">ModbusMaster</a> invalid response function exception.  <a href="group__constant.html#ga31e9072531cf487c137b68b5e1e68926"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__constant.html#ga8eb8e14ee2bcf58afc3fbbb4014f297c">ku8MBResponseTimedOut</a> = 0xE2</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><a class="el" href="class_modbus_master.html" title="Arduino class library for communicating with Modbus slaves over RS232/485 (via RTU...">ModbusMaster</a> response timed out exception.  <a href="group__constant.html#ga8eb8e14ee2bcf58afc3fbbb4014f297c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__constant.html#gaa73463392a988bbc5260690168b5ca08">ku8MBInvalidCRC</a> = 0xE3</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><a class="el" href="class_modbus_master.html" title="Arduino class library for communicating with Modbus slaves over RS232/485 (via RTU...">ModbusMaster</a> invalid response CRC exception.  <a href="group__constant.html#gaa73463392a988bbc5260690168b5ca08"></a><br/></td></tr>
<tr><td colspan="2"><h2>Private Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a4c88df0ed38e98457e8ac74c2ed5dc81">ModbusMasterTransaction</a> (uint8_t u8MBFunction)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus transaction engine.  <a href="#a4c88df0ed38e98457e8ac74c2ed5dc81"></a><br/></td></tr>
<tr><td colspan="2"><h2>Private Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8059450709d3ef2f7b817e24ede57a94"></a><!-- doxytag: member="ModbusMaster::_u8SerialPort" ref="a8059450709d3ef2f7b817e24ede57a94" args="" -->
uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a8059450709d3ef2f7b817e24ede57a94">_u8SerialPort</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">serial port (0..3) initialized in constructor <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8bc19d22b864e85ad67b4b633fa56597"></a><!-- doxytag: member="ModbusMaster::_u8MBSlave" ref="a8bc19d22b864e85ad67b4b633fa56597" args="" -->
uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a8bc19d22b864e85ad67b4b633fa56597">_u8MBSlave</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus slave (1..255) initialized in constructor. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a2c3bdb0037ef87da266e46a6ecdd8a84"></a><!-- doxytag: member="ModbusMaster::_u16BaudRate" ref="a2c3bdb0037ef87da266e46a6ecdd8a84" args="" -->
uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a2c3bdb0037ef87da266e46a6ecdd8a84">_u16BaudRate</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">baud rate (300..115200) initialized in <a class="el" href="group__setup.html#ga0f393213ede2f78801fca5add4eab139" title="Initialize class object.">begin()</a> <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="adfb48ef6321f738cc4b55c4b6e4a6335"></a><!-- doxytag: member="ModbusMaster::_u16ReadAddress" ref="adfb48ef6321f738cc4b55c4b6e4a6335" args="" -->
uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#adfb48ef6321f738cc4b55c4b6e4a6335">_u16ReadAddress</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">slave register from which to read <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a043a88f0b184accd9176770dee55a6b3"></a><!-- doxytag: member="ModbusMaster::_u16ReadQty" ref="a043a88f0b184accd9176770dee55a6b3" args="" -->
uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a043a88f0b184accd9176770dee55a6b3">_u16ReadQty</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">quantity of words to read <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a347a26fa1b91d7d0210b021e52a95268"></a><!-- doxytag: member="ModbusMaster::_u16ResponseBuffer" ref="a347a26fa1b91d7d0210b021e52a95268" args="[ku8MaxBufferSize]" -->
uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a347a26fa1b91d7d0210b021e52a95268">_u16ResponseBuffer</a> [<a class="el" href="class_modbus_master.html#ab9a1a34c8e3bbd84529230e559694c29">ku8MaxBufferSize</a>]</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">buffer to store Modbus slave response; read via <a class="el" href="group__buffer.html#ga2584dd744a983ec2f898cdc42ab303cc" title="Retrieve data from response buffer.">GetResponseBuffer()</a> <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a00edff3fbd53d94dcc1b6be593c61289"></a><!-- doxytag: member="ModbusMaster::_u16WriteAddress" ref="a00edff3fbd53d94dcc1b6be593c61289" args="" -->
uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a00edff3fbd53d94dcc1b6be593c61289">_u16WriteAddress</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">slave register to which to write <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ad3191c5da05cf72e117814ba0472b420"></a><!-- doxytag: member="ModbusMaster::_u16WriteQty" ref="ad3191c5da05cf72e117814ba0472b420" args="" -->
uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420">_u16WriteQty</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">quantity of words to write <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8a79a050ef684f78b06b7543a56f54fb"></a><!-- doxytag: member="ModbusMaster::_u16TransmitBuffer" ref="a8a79a050ef684f78b06b7543a56f54fb" args="[ku8MaxBufferSize]" -->
uint16_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb">_u16TransmitBuffer</a> [<a class="el" href="class_modbus_master.html#ab9a1a34c8e3bbd84529230e559694c29">ku8MaxBufferSize</a>]</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">buffer containing data to transmit to Modbus slave; set via <a class="el" href="group__buffer.html#ga19a72b096a5d55e873c72ffbc266ea76" title="Place data in transmit buffer.">SetTransmitBuffer()</a> <br/></td></tr>
<tr><td colspan="2"><h2>Static Private Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ab9a1a34c8e3bbd84529230e559694c29"></a><!-- doxytag: member="ModbusMaster::ku8MaxBufferSize" ref="ab9a1a34c8e3bbd84529230e559694c29" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#ab9a1a34c8e3bbd84529230e559694c29">ku8MaxBufferSize</a> = 64</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">size of response/transmit buffers <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ad7e7aa7bed1b86f24bd577725edc633d"></a><!-- doxytag: member="ModbusMaster::ku8MBReadCoils" ref="ad7e7aa7bed1b86f24bd577725edc633d" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#ad7e7aa7bed1b86f24bd577725edc633d">ku8MBReadCoils</a> = 0x01</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x01 Read Coils. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae08306bd72d5487bccf16c12ade79098"></a><!-- doxytag: member="ModbusMaster::ku8MBReadDiscreteInputs" ref="ae08306bd72d5487bccf16c12ade79098" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#ae08306bd72d5487bccf16c12ade79098">ku8MBReadDiscreteInputs</a> = 0x02</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x02 Read Discrete Inputs. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a401bf89674f94726efca951115704869"></a><!-- doxytag: member="ModbusMaster::ku8MBWriteSingleCoil" ref="a401bf89674f94726efca951115704869" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a401bf89674f94726efca951115704869">ku8MBWriteSingleCoil</a> = 0x05</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x05 Write Single Coil. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a31e5f44d74fa84bf4c9440c82d123fe9"></a><!-- doxytag: member="ModbusMaster::ku8MBWriteMultipleCoils" ref="a31e5f44d74fa84bf4c9440c82d123fe9" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a31e5f44d74fa84bf4c9440c82d123fe9">ku8MBWriteMultipleCoils</a> = 0x0F</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x0F Write Multiple Coils. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae6995c167c152d96b06a918869c03623"></a><!-- doxytag: member="ModbusMaster::ku8MBReadHoldingRegisters" ref="ae6995c167c152d96b06a918869c03623" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#ae6995c167c152d96b06a918869c03623">ku8MBReadHoldingRegisters</a> = 0x03</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x03 Read Holding Registers. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aeaa94736b198f6a05cf74e0466afb443"></a><!-- doxytag: member="ModbusMaster::ku8MBReadInputRegisters" ref="aeaa94736b198f6a05cf74e0466afb443" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#aeaa94736b198f6a05cf74e0466afb443">ku8MBReadInputRegisters</a> = 0x04</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x04 Read Input Registers. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ab68b007cd9473c3ed09f36fb0f6ee3fa"></a><!-- doxytag: member="ModbusMaster::ku8MBWriteSingleRegister" ref="ab68b007cd9473c3ed09f36fb0f6ee3fa" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#ab68b007cd9473c3ed09f36fb0f6ee3fa">ku8MBWriteSingleRegister</a> = 0x06</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x06 Write Single Register. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="adf1f58e7806d4c7bc1638255e2639b86"></a><!-- doxytag: member="ModbusMaster::ku8MBWriteMultipleRegisters" ref="adf1f58e7806d4c7bc1638255e2639b86" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#adf1f58e7806d4c7bc1638255e2639b86">ku8MBWriteMultipleRegisters</a> = 0x10</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x10 Write Multiple Registers. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a1de5e699bcada855fb26e336d2cd2cd3"></a><!-- doxytag: member="ModbusMaster::ku8MBMaskWriteRegister" ref="a1de5e699bcada855fb26e336d2cd2cd3" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#a1de5e699bcada855fb26e336d2cd2cd3">ku8MBMaskWriteRegister</a> = 0x16</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x16 Mask Write Register. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af1c77f6f5f7e0f19d0c9b9916dca2263"></a><!-- doxytag: member="ModbusMaster::ku8MBReadWriteMultipleRegisters" ref="af1c77f6f5f7e0f19d0c9b9916dca2263" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#af1c77f6f5f7e0f19d0c9b9916dca2263">ku8MBReadWriteMultipleRegisters</a> = 0x17</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus function 0x17 Read Write Multiple Registers. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ac9c5d42e3b5cd7ec40ce0c86f6fc1772"></a><!-- doxytag: member="ModbusMaster::ku8MBResponseTimeout" ref="ac9c5d42e3b5cd7ec40ce0c86f6fc1772" args="" -->
static const uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_modbus_master.html#ac9c5d42e3b5cd7ec40ce0c86f6fc1772">ku8MBResponseTimeout</a> = 200</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Modbus timeout [milliseconds]. <br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Arduino class library for communicating with Modbus slaves over RS232/485 (via RTU protocol). </p>
<dl><dt><b>Examples: </b></dt><dd>
<p><a class="el" href="examples_2_basic_2_basic_8pde-example.html#_a0">examples/Basic/Basic.pde</a>, and <a class="el" href="examples_2_phoenix_contact__nano_l_c_2_phoenix_contact__nano_l_c_8pde-example.html#_a0">examples/PhoenixContact_nanoLC/PhoenixContact_nanoLC.pde</a>.</p>
</dd>
</dl><hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a4c88df0ed38e98457e8ac74c2ed5dc81"></a><!-- doxytag: member="ModbusMaster::ModbusMasterTransaction" ref="a4c88df0ed38e98457e8ac74c2ed5dc81" args="(uint8_t u8MBFunction)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t ModbusMaster::ModbusMasterTransaction </td>
          <td>(</td>
          <td class="paramtype">uint8_t&nbsp;</td>
          <td class="paramname"> <em>u8MBFunction</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Modbus transaction engine. </p>
<p>Sequence:</p>
<ul>
<li>assemble Modbus Request Application Data Unit (ADU), based on particular function called</li>
<li>transmit request over selected serial port</li>
<li>wait for/retrieve response</li>
<li>evaluate/disassemble response</li>
<li>return status (success/exception)</li>
</ul>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>u8MBFunction</em>&nbsp;</td><td>Modbus function (0x01..0xFF) </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 on success; exception number on failure </dd></dl>

<p><div class="fragment"><pre class="fragment"><a name="l00507"></a>00507 {
<a name="l00508"></a>00508   uint8_t u8ModbusADU[256];
<a name="l00509"></a>00509   uint8_t u8ModbusADUSize = 0;
<a name="l00510"></a>00510   uint8_t i, u8Qty;
<a name="l00511"></a>00511   uint16_t u16CRC;
<a name="l00512"></a>00512   uint8_t u8TimeLeft = <a class="code" href="class_modbus_master.html#ac9c5d42e3b5cd7ec40ce0c86f6fc1772" title="Modbus timeout [milliseconds].">ku8MBResponseTimeout</a>;
<a name="l00513"></a>00513   uint8_t u8BytesLeft = 8;
<a name="l00514"></a>00514   uint8_t u8MBStatus = <a class="code" href="group__constant.html#ga81dd9e8d2936e369359777d67769a657" title="ModbusMaster success.">ku8MBSuccess</a>;
<a name="l00515"></a>00515   
<a name="l00516"></a>00516   <span class="comment">// assemble Modbus Request Application Data Unit</span>
<a name="l00517"></a>00517   u8ModbusADU[u8ModbusADUSize++] = <a class="code" href="class_modbus_master.html#a8bc19d22b864e85ad67b4b633fa56597" title="Modbus slave (1..255) initialized in constructor.">_u8MBSlave</a>;
<a name="l00518"></a>00518   u8ModbusADU[u8ModbusADUSize++] = u8MBFunction;
<a name="l00519"></a>00519   
<a name="l00520"></a>00520   <span class="keywordflow">switch</span>(u8MBFunction)
<a name="l00521"></a>00521   {
<a name="l00522"></a>00522     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ad7e7aa7bed1b86f24bd577725edc633d" title="Modbus function 0x01 Read Coils.">ku8MBReadCoils</a>:
<a name="l00523"></a>00523     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ae08306bd72d5487bccf16c12ade79098" title="Modbus function 0x02 Read Discrete Inputs.">ku8MBReadDiscreteInputs</a>:
<a name="l00524"></a>00524     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#aeaa94736b198f6a05cf74e0466afb443" title="Modbus function 0x04 Read Input Registers.">ku8MBReadInputRegisters</a>:
<a name="l00525"></a>00525     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ae6995c167c152d96b06a918869c03623" title="Modbus function 0x03 Read Holding Registers.">ku8MBReadHoldingRegisters</a>:
<a name="l00526"></a>00526     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#af1c77f6f5f7e0f19d0c9b9916dca2263" title="Modbus function 0x17 Read Write Multiple Registers.">ku8MBReadWriteMultipleRegisters</a>:
<a name="l00527"></a>00527       u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#adfb48ef6321f738cc4b55c4b6e4a6335" title="slave register from which to read">_u16ReadAddress</a>);
<a name="l00528"></a>00528       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#adfb48ef6321f738cc4b55c4b6e4a6335" title="slave register from which to read">_u16ReadAddress</a>);
<a name="l00529"></a>00529       u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#a043a88f0b184accd9176770dee55a6b3" title="quantity of words to read">_u16ReadQty</a>);
<a name="l00530"></a>00530       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#a043a88f0b184accd9176770dee55a6b3" title="quantity of words to read">_u16ReadQty</a>);
<a name="l00531"></a>00531       <span class="keywordflow">break</span>;
<a name="l00532"></a>00532   }
<a name="l00533"></a>00533   
<a name="l00534"></a>00534   <span class="keywordflow">switch</span>(u8MBFunction)
<a name="l00535"></a>00535   {
<a name="l00536"></a>00536     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#a401bf89674f94726efca951115704869" title="Modbus function 0x05 Write Single Coil.">ku8MBWriteSingleCoil</a>:
<a name="l00537"></a>00537     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#a1de5e699bcada855fb26e336d2cd2cd3" title="Modbus function 0x16 Mask Write Register.">ku8MBMaskWriteRegister</a>:
<a name="l00538"></a>00538     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#a31e5f44d74fa84bf4c9440c82d123fe9" title="Modbus function 0x0F Write Multiple Coils.">ku8MBWriteMultipleCoils</a>:
<a name="l00539"></a>00539     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ab68b007cd9473c3ed09f36fb0f6ee3fa" title="Modbus function 0x06 Write Single Register.">ku8MBWriteSingleRegister</a>:
<a name="l00540"></a>00540     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#adf1f58e7806d4c7bc1638255e2639b86" title="Modbus function 0x10 Write Multiple Registers.">ku8MBWriteMultipleRegisters</a>:
<a name="l00541"></a>00541     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#af1c77f6f5f7e0f19d0c9b9916dca2263" title="Modbus function 0x17 Read Write Multiple Registers.">ku8MBReadWriteMultipleRegisters</a>:
<a name="l00542"></a>00542       u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#a00edff3fbd53d94dcc1b6be593c61289" title="slave register to which to write">_u16WriteAddress</a>);
<a name="l00543"></a>00543       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#a00edff3fbd53d94dcc1b6be593c61289" title="slave register to which to write">_u16WriteAddress</a>);
<a name="l00544"></a>00544       <span class="keywordflow">break</span>;
<a name="l00545"></a>00545   }
<a name="l00546"></a>00546   
<a name="l00547"></a>00547   <span class="keywordflow">switch</span>(u8MBFunction)
<a name="l00548"></a>00548   {
<a name="l00549"></a>00549     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#a401bf89674f94726efca951115704869" title="Modbus function 0x05 Write Single Coil.">ku8MBWriteSingleCoil</a>:
<a name="l00550"></a>00550       u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a>);
<a name="l00551"></a>00551       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a>);
<a name="l00552"></a>00552       <span class="keywordflow">break</span>;
<a name="l00553"></a>00553       
<a name="l00554"></a>00554     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ab68b007cd9473c3ed09f36fb0f6ee3fa" title="Modbus function 0x06 Write Single Register.">ku8MBWriteSingleRegister</a>:
<a name="l00555"></a>00555       u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[0]);
<a name="l00556"></a>00556       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[0]);
<a name="l00557"></a>00557       <span class="keywordflow">break</span>;
<a name="l00558"></a>00558       
<a name="l00559"></a>00559     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#a31e5f44d74fa84bf4c9440c82d123fe9" title="Modbus function 0x0F Write Multiple Coils.">ku8MBWriteMultipleCoils</a>:
<a name="l00560"></a>00560       u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a>);
<a name="l00561"></a>00561       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a>);
<a name="l00562"></a>00562       u8Qty = (<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a> % 8) ? ((<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a> &gt;&gt; 3) + 1) : (<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a> &gt;&gt; 3);
<a name="l00563"></a>00563       u8ModbusADU[u8ModbusADUSize++] = u8Qty;
<a name="l00564"></a>00564       <span class="keywordflow">for</span> (i = 0; i &lt; u8Qty; i++)
<a name="l00565"></a>00565       {
<a name="l00566"></a>00566         <span class="keywordflow">switch</span>(i % 2)
<a name="l00567"></a>00567         {
<a name="l00568"></a>00568           <span class="keywordflow">case</span> 0: <span class="comment">// i is even</span>
<a name="l00569"></a>00569             u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[i &gt;&gt; 1]);
<a name="l00570"></a>00570             <span class="keywordflow">break</span>;
<a name="l00571"></a>00571             
<a name="l00572"></a>00572           <span class="keywordflow">case</span> 1: <span class="comment">// i is odd</span>
<a name="l00573"></a>00573             u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[i &gt;&gt; 1]);
<a name="l00574"></a>00574             <span class="keywordflow">break</span>;
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576       }
<a name="l00577"></a>00577       <span class="keywordflow">break</span>;
<a name="l00578"></a>00578       
<a name="l00579"></a>00579     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#adf1f58e7806d4c7bc1638255e2639b86" title="Modbus function 0x10 Write Multiple Registers.">ku8MBWriteMultipleRegisters</a>:
<a name="l00580"></a>00580     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#af1c77f6f5f7e0f19d0c9b9916dca2263" title="Modbus function 0x17 Read Write Multiple Registers.">ku8MBReadWriteMultipleRegisters</a>:
<a name="l00581"></a>00581       u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a>);
<a name="l00582"></a>00582       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a>);
<a name="l00583"></a>00583       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a> &lt;&lt; 1);
<a name="l00584"></a>00584       
<a name="l00585"></a>00585       <span class="keywordflow">for</span> (i = 0; i &lt; lowByte(<a class="code" href="class_modbus_master.html#ad3191c5da05cf72e117814ba0472b420" title="quantity of words to write">_u16WriteQty</a>); i++)
<a name="l00586"></a>00586       {
<a name="l00587"></a>00587         u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[i]);
<a name="l00588"></a>00588         u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[i]);
<a name="l00589"></a>00589       }
<a name="l00590"></a>00590       <span class="keywordflow">break</span>;
<a name="l00591"></a>00591       
<a name="l00592"></a>00592     <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#a1de5e699bcada855fb26e336d2cd2cd3" title="Modbus function 0x16 Mask Write Register.">ku8MBMaskWriteRegister</a>:
<a name="l00593"></a>00593       u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[0]);
<a name="l00594"></a>00594       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[0]);
<a name="l00595"></a>00595       u8ModbusADU[u8ModbusADUSize++] = highByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[1]);
<a name="l00596"></a>00596       u8ModbusADU[u8ModbusADUSize++] = lowByte(<a class="code" href="class_modbus_master.html#a8a79a050ef684f78b06b7543a56f54fb" title="buffer containing data to transmit to Modbus slave; set via SetTransmitBuffer()">_u16TransmitBuffer</a>[1]);
<a name="l00597"></a>00597       <span class="keywordflow">break</span>;
<a name="l00598"></a>00598   }
<a name="l00599"></a>00599   
<a name="l00600"></a>00600   
<a name="l00601"></a>00601   <span class="comment">// append CRC</span>
<a name="l00602"></a>00602   u16CRC = 0xFFFF;
<a name="l00603"></a>00603   <span class="keywordflow">for</span> (i = 0; i &lt; u8ModbusADUSize; i++)
<a name="l00604"></a>00604   {
<a name="l00605"></a>00605     u16CRC = _crc16_update(u16CRC, u8ModbusADU[i]);
<a name="l00606"></a>00606   }
<a name="l00607"></a>00607   u8ModbusADU[u8ModbusADUSize++] = lowByte(u16CRC);
<a name="l00608"></a>00608   u8ModbusADU[u8ModbusADUSize++] = highByte(u16CRC);
<a name="l00609"></a>00609   u8ModbusADU[u8ModbusADUSize] = 0;
<a name="l00610"></a>00610   
<a name="l00611"></a>00611   <span class="comment">// transmit request</span>
<a name="l00612"></a>00612   <span class="keywordflow">for</span> (i = 0; i &lt; u8ModbusADUSize; i++)
<a name="l00613"></a>00613   {
<a name="l00614"></a>00614     MBSerial.print(u8ModbusADU[i], BYTE);
<a name="l00615"></a>00615   }
<a name="l00616"></a>00616   
<a name="l00617"></a>00617   u8ModbusADUSize = 0;
<a name="l00618"></a>00618   MBSerial.flush();
<a name="l00619"></a>00619   
<a name="l00620"></a>00620   <span class="comment">// loop until we run out of time or bytes, or an error occurs</span>
<a name="l00621"></a>00621   <span class="keywordflow">while</span> (u8TimeLeft &amp;&amp; u8BytesLeft &amp;&amp; !u8MBStatus)
<a name="l00622"></a>00622   {
<a name="l00623"></a>00623     <span class="keywordflow">if</span> (MBSerial.available())
<a name="l00624"></a>00624     {
<a name="l00625"></a>00625 <span class="preprocessor">#if __MODBUSMASTER_DEBUG__</span>
<a name="l00626"></a>00626 <span class="preprocessor"></span>      digitalWrite(4, <span class="keyword">true</span>);
<a name="l00627"></a>00627 <span class="preprocessor">#endif</span>
<a name="l00628"></a>00628 <span class="preprocessor"></span>      u8ModbusADU[u8ModbusADUSize++] = MBSerial.read();
<a name="l00629"></a>00629       u8BytesLeft--;
<a name="l00630"></a>00630 <span class="preprocessor">#if __MODBUSMASTER_DEBUG__</span>
<a name="l00631"></a>00631 <span class="preprocessor"></span>      digitalWrite(4, <span class="keyword">false</span>);
<a name="l00632"></a>00632 <span class="preprocessor">#endif</span>
<a name="l00633"></a>00633 <span class="preprocessor"></span>    }
<a name="l00634"></a>00634     <span class="keywordflow">else</span>
<a name="l00635"></a>00635     {
<a name="l00636"></a>00636 <span class="preprocessor">#if __MODBUSMASTER_DEBUG__</span>
<a name="l00637"></a>00637 <span class="preprocessor"></span>      digitalWrite(5, <span class="keyword">true</span>);
<a name="l00638"></a>00638 <span class="preprocessor">#endif</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span>      delayMicroseconds(1000);
<a name="l00640"></a>00640       u8TimeLeft--;
<a name="l00641"></a>00641 <span class="preprocessor">#if __MODBUSMASTER_DEBUG__</span>
<a name="l00642"></a>00642 <span class="preprocessor"></span>      digitalWrite(5, <span class="keyword">false</span>);
<a name="l00643"></a>00643 <span class="preprocessor">#endif</span>
<a name="l00644"></a>00644 <span class="preprocessor"></span>    }
<a name="l00645"></a>00645     
<a name="l00646"></a>00646     <span class="comment">// evaluate slave ID, function code once enough bytes have been read</span>
<a name="l00647"></a>00647     <span class="keywordflow">if</span> (u8ModbusADUSize == 5)
<a name="l00648"></a>00648     {
<a name="l00649"></a>00649       <span class="comment">// verify response is for correct Modbus slave</span>
<a name="l00650"></a>00650       <span class="keywordflow">if</span> (u8ModbusADU[0] != <a class="code" href="class_modbus_master.html#a8bc19d22b864e85ad67b4b633fa56597" title="Modbus slave (1..255) initialized in constructor.">_u8MBSlave</a>)
<a name="l00651"></a>00651       {
<a name="l00652"></a>00652         u8MBStatus = <a class="code" href="group__constant.html#ga19521b4671bdc1ded03af72e2f3b958e" title="ModbusMaster invalid response slave ID exception.">ku8MBInvalidSlaveID</a>;
<a name="l00653"></a>00653         <span class="keywordflow">break</span>;
<a name="l00654"></a>00654       }
<a name="l00655"></a>00655       
<a name="l00656"></a>00656       <span class="comment">// verify response is for correct Modbus function code (mask exception bit 7)</span>
<a name="l00657"></a>00657       <span class="keywordflow">if</span> ((u8ModbusADU[1] &amp; 0x7F) != u8MBFunction)
<a name="l00658"></a>00658       {
<a name="l00659"></a>00659         u8MBStatus = <a class="code" href="group__constant.html#ga31e9072531cf487c137b68b5e1e68926" title="ModbusMaster invalid response function exception.">ku8MBInvalidFunction</a>;
<a name="l00660"></a>00660         <span class="keywordflow">break</span>;
<a name="l00661"></a>00661       }
<a name="l00662"></a>00662       
<a name="l00663"></a>00663       <span class="comment">// check whether Modbus exception occurred; return Modbus Exception Code</span>
<a name="l00664"></a>00664       <span class="keywordflow">if</span> (bitRead(u8ModbusADU[1], 7))
<a name="l00665"></a>00665       {
<a name="l00666"></a>00666         u8MBStatus = u8ModbusADU[2];
<a name="l00667"></a>00667         <span class="keywordflow">break</span>;
<a name="l00668"></a>00668       }
<a name="l00669"></a>00669       
<a name="l00670"></a>00670       <span class="comment">// evaluate returned Modbus function code</span>
<a name="l00671"></a>00671       <span class="keywordflow">switch</span>(u8ModbusADU[1])
<a name="l00672"></a>00672       {
<a name="l00673"></a>00673         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ad7e7aa7bed1b86f24bd577725edc633d" title="Modbus function 0x01 Read Coils.">ku8MBReadCoils</a>:
<a name="l00674"></a>00674         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ae08306bd72d5487bccf16c12ade79098" title="Modbus function 0x02 Read Discrete Inputs.">ku8MBReadDiscreteInputs</a>:
<a name="l00675"></a>00675         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#aeaa94736b198f6a05cf74e0466afb443" title="Modbus function 0x04 Read Input Registers.">ku8MBReadInputRegisters</a>:
<a name="l00676"></a>00676         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ae6995c167c152d96b06a918869c03623" title="Modbus function 0x03 Read Holding Registers.">ku8MBReadHoldingRegisters</a>:
<a name="l00677"></a>00677         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#af1c77f6f5f7e0f19d0c9b9916dca2263" title="Modbus function 0x17 Read Write Multiple Registers.">ku8MBReadWriteMultipleRegisters</a>:
<a name="l00678"></a>00678           u8BytesLeft = u8ModbusADU[2];
<a name="l00679"></a>00679           <span class="keywordflow">break</span>;
<a name="l00680"></a>00680           
<a name="l00681"></a>00681         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#a401bf89674f94726efca951115704869" title="Modbus function 0x05 Write Single Coil.">ku8MBWriteSingleCoil</a>:
<a name="l00682"></a>00682         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#a31e5f44d74fa84bf4c9440c82d123fe9" title="Modbus function 0x0F Write Multiple Coils.">ku8MBWriteMultipleCoils</a>:
<a name="l00683"></a>00683         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ab68b007cd9473c3ed09f36fb0f6ee3fa" title="Modbus function 0x06 Write Single Register.">ku8MBWriteSingleRegister</a>:
<a name="l00684"></a>00684           u8BytesLeft = 3;
<a name="l00685"></a>00685           <span class="keywordflow">break</span>;
<a name="l00686"></a>00686           
<a name="l00687"></a>00687         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#a1de5e699bcada855fb26e336d2cd2cd3" title="Modbus function 0x16 Mask Write Register.">ku8MBMaskWriteRegister</a>:
<a name="l00688"></a>00688           u8BytesLeft = 5;
<a name="l00689"></a>00689           <span class="keywordflow">break</span>;
<a name="l00690"></a>00690       }
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692     
<a name="l00693"></a>00693     <span class="keywordflow">if</span> (u8ModbusADUSize == 6)
<a name="l00694"></a>00694     {
<a name="l00695"></a>00695       <span class="keywordflow">switch</span>(u8ModbusADU[1])
<a name="l00696"></a>00696       {
<a name="l00697"></a>00697         <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#adf1f58e7806d4c7bc1638255e2639b86" title="Modbus function 0x10 Write Multiple Registers.">ku8MBWriteMultipleRegisters</a>:
<a name="l00698"></a>00698           u8BytesLeft = u8ModbusADU[5];
<a name="l00699"></a>00699           <span class="keywordflow">break</span>;
<a name="l00700"></a>00700       }
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702   }
<a name="l00703"></a>00703   
<a name="l00704"></a>00704   <span class="comment">// verify response is large enough to inspect further</span>
<a name="l00705"></a>00705   <span class="keywordflow">if</span> (!u8MBStatus &amp;&amp; (u8TimeLeft == 0 || u8ModbusADUSize &lt; 5))
<a name="l00706"></a>00706   {
<a name="l00707"></a>00707     u8MBStatus = <a class="code" href="group__constant.html#ga8eb8e14ee2bcf58afc3fbbb4014f297c" title="ModbusMaster response timed out exception.">ku8MBResponseTimedOut</a>;
<a name="l00708"></a>00708   }
<a name="l00709"></a>00709   
<a name="l00710"></a>00710   <span class="comment">// calculate CRC</span>
<a name="l00711"></a>00711   u16CRC = 0xFFFF;
<a name="l00712"></a>00712   <span class="keywordflow">for</span> (i = 0; i &lt; (u8ModbusADUSize - 2); i++)
<a name="l00713"></a>00713   {
<a name="l00714"></a>00714     u16CRC = _crc16_update(u16CRC, u8ModbusADU[i]);
<a name="l00715"></a>00715   }
<a name="l00716"></a>00716   
<a name="l00717"></a>00717   <span class="comment">// verify CRC</span>
<a name="l00718"></a>00718   <span class="keywordflow">if</span> (!u8MBStatus &amp;&amp; (lowByte(u16CRC) != u8ModbusADU[u8ModbusADUSize - 2] ||
<a name="l00719"></a>00719     highByte(u16CRC) != u8ModbusADU[u8ModbusADUSize - 1]))
<a name="l00720"></a>00720   {
<a name="l00721"></a>00721     u8MBStatus = <a class="code" href="group__constant.html#gaa73463392a988bbc5260690168b5ca08" title="ModbusMaster invalid response CRC exception.">ku8MBInvalidCRC</a>;
<a name="l00722"></a>00722   }
<a name="l00723"></a>00723 
<a name="l00724"></a>00724   <span class="comment">// disassemble ADU into words</span>
<a name="l00725"></a>00725   <span class="keywordflow">if</span> (!u8MBStatus)
<a name="l00726"></a>00726   {
<a name="l00727"></a>00727     <span class="comment">// evaluate returned Modbus function code</span>
<a name="l00728"></a>00728     <span class="keywordflow">switch</span>(u8ModbusADU[1])
<a name="l00729"></a>00729     {
<a name="l00730"></a>00730       <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ad7e7aa7bed1b86f24bd577725edc633d" title="Modbus function 0x01 Read Coils.">ku8MBReadCoils</a>:
<a name="l00731"></a>00731       <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ae08306bd72d5487bccf16c12ade79098" title="Modbus function 0x02 Read Discrete Inputs.">ku8MBReadDiscreteInputs</a>:
<a name="l00732"></a>00732         <span class="comment">// load bytes into word; response bytes are ordered L, H, L, H, ...</span>
<a name="l00733"></a>00733         <span class="keywordflow">for</span> (i = 0; i &lt; (u8ModbusADU[2] &gt;&gt; 1); i++)
<a name="l00734"></a>00734         {
<a name="l00735"></a>00735           <span class="keywordflow">if</span> (i &lt; <a class="code" href="class_modbus_master.html#ab9a1a34c8e3bbd84529230e559694c29" title="size of response/transmit buffers">ku8MaxBufferSize</a>)
<a name="l00736"></a>00736           {
<a name="l00737"></a>00737             <a class="code" href="class_modbus_master.html#a347a26fa1b91d7d0210b021e52a95268" title="buffer to store Modbus slave response; read via GetResponseBuffer()">_u16ResponseBuffer</a>[i] = word(u8ModbusADU[2 * i + 4], u8ModbusADU[2 * i + 3]);
<a name="l00738"></a>00738           }
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740         
<a name="l00741"></a>00741         <span class="comment">// in the event of an odd number of bytes, load last byte into zero-padded word</span>
<a name="l00742"></a>00742         <span class="keywordflow">if</span> (u8ModbusADU[2] % 2)
<a name="l00743"></a>00743         {
<a name="l00744"></a>00744           <span class="keywordflow">if</span> (i &lt; <a class="code" href="class_modbus_master.html#ab9a1a34c8e3bbd84529230e559694c29" title="size of response/transmit buffers">ku8MaxBufferSize</a>)
<a name="l00745"></a>00745           {
<a name="l00746"></a>00746             <a class="code" href="class_modbus_master.html#a347a26fa1b91d7d0210b021e52a95268" title="buffer to store Modbus slave response; read via GetResponseBuffer()">_u16ResponseBuffer</a>[i] = word(0, u8ModbusADU[2 * i + 3]);
<a name="l00747"></a>00747           }
<a name="l00748"></a>00748         }
<a name="l00749"></a>00749         <span class="keywordflow">break</span>;
<a name="l00750"></a>00750         
<a name="l00751"></a>00751       <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#aeaa94736b198f6a05cf74e0466afb443" title="Modbus function 0x04 Read Input Registers.">ku8MBReadInputRegisters</a>:
<a name="l00752"></a>00752       <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#ae6995c167c152d96b06a918869c03623" title="Modbus function 0x03 Read Holding Registers.">ku8MBReadHoldingRegisters</a>:
<a name="l00753"></a>00753       <span class="keywordflow">case</span> <a class="code" href="class_modbus_master.html#af1c77f6f5f7e0f19d0c9b9916dca2263" title="Modbus function 0x17 Read Write Multiple Registers.">ku8MBReadWriteMultipleRegisters</a>:
<a name="l00754"></a>00754         <span class="comment">// load bytes into word; response bytes are ordered H, L, H, L, ...</span>
<a name="l00755"></a>00755         <span class="keywordflow">for</span> (i = 0; i &lt; (u8ModbusADU[2] &gt;&gt; 1); i++)
<a name="l00756"></a>00756         {
<a name="l00757"></a>00757           <span class="keywordflow">if</span> (i &lt; <a class="code" href="class_modbus_master.html#ab9a1a34c8e3bbd84529230e559694c29" title="size of response/transmit buffers">ku8MaxBufferSize</a>)
<a name="l00758"></a>00758           {
<a name="l00759"></a>00759             <a class="code" href="class_modbus_master.html#a347a26fa1b91d7d0210b021e52a95268" title="buffer to store Modbus slave response; read via GetResponseBuffer()">_u16ResponseBuffer</a>[i] = word(u8ModbusADU[2 * i + 3], u8ModbusADU[2 * i + 4]);
<a name="l00760"></a>00760           }
<a name="l00761"></a>00761         }
<a name="l00762"></a>00762         <span class="keywordflow">break</span>;
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764   }
<a name="l00765"></a>00765   
<a name="l00766"></a>00766   <span class="keywordflow">return</span> u8MBStatus;
<a name="l00767"></a>00767 }
</pre></div></p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="_modbus_master_8h_source.html">ModbusMaster.h</a></li>
<li>ModbusMaster.cpp</li>
</ul>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.2 </small></address>
</body>
</html>
